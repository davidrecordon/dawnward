# Richer Summary Cards + Remove scheduleViewMode — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make summary card descriptions dynamic and personalized by adding a Python-generated `summary` field, and remove the `scheduleViewMode` preference in favor of viewport-driven behavior.

**Architecture:** Two independent parts. Part 1 adds a `summary` field to the Python `Intervention` dataclass, generates personalized one-liners at schedule creation time, and uses them in the frontend with a static fallback. Part 2 removes `scheduleViewMode` from the DB, types, settings UI, context, and pages — replacing it with purely viewport-driven logic (desktop=expanded, mobile=collapsed).

**Tech Stack:** Python (dataclasses, pytest), TypeScript/React (Next.js, Prisma, Vitest), Prisma migrations

**Design doc:** `design_docs/shovel_ready/2026-02-13-richer-summaries-design.md`

---

## Part 1: Python-Generated Summary Field

### Task 1: Add `summary` field to Python Intervention dataclass

**Files:**
- Modify: `api/_python/circadian/types.py:135-183` (Intervention dataclass)

**Step 1: Add the field**

Add after `original_time` (line 182):

```python
    # One-line summary for collapsed card view (generated by planner)
    summary: str | None = None
```

**Step 2: Add duration formatting helper**

Add a module-level helper function before the Intervention class:

```python
def format_duration_short(minutes: int | None) -> str:
    """Format duration for summary display: >=60 min as hours, <60 as minutes."""
    if minutes is None:
        return ""
    if minutes >= 60:
        hours = minutes / 60
        # Show as integer if whole number, one decimal otherwise
        if hours == int(hours):
            return f"{int(hours)}h"
        return f"{hours:.1f}h"
    return f"{minutes} min"
```

**Step 3: Run existing tests to verify no breakage**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run test:python`
Expected: All ~345 tests pass (new field defaults to None, backward compatible)

**Step 4: Commit**

```
feat: add summary field to Intervention dataclass
```

---

### Task 2: Write tests for summary generation

**Files:**
- Create: `api/_python/tests/test_summary_field.py`

**Step 1: Write tests for each intervention type's summary**

```python
"""Tests for Intervention.summary field generation."""
import pytest
from datetime import datetime, timedelta
from circadian.scheduler_v2 import SchedulerV2
from circadian.types import ScheduleRequest, TripLeg


def _make_request(
    origin_tz: str = "America/Los_Angeles",
    dest_tz: str = "Europe/London",
    direction: str = "advance",  # advance = eastward
    **kwargs,
) -> ScheduleRequest:
    """Build a ScheduleRequest for the given direction."""
    now = datetime.now()

    if direction == "advance":
        # LA -> London (eastward, 8h advance)
        dep = now + timedelta(days=3)
        dep_str = dep.strftime("%Y-%m-%dT16:00")
        arr_next = dep + timedelta(hours=11)
        arr_str = arr_next.strftime("%Y-%m-%dT11:00")
        o_tz, d_tz = origin_tz, dest_tz
    else:
        # London -> LA (westward, 8h delay)
        dep = now + timedelta(days=3)
        dep_str = dep.strftime("%Y-%m-%dT11:00")
        arr_next = dep + timedelta(hours=11)
        arr_str = arr_next.strftime("%Y-%m-%dT14:00")
        o_tz, d_tz = dest_tz, origin_tz

    defaults = dict(
        legs=[TripLeg(
            origin_tz=o_tz,
            dest_tz=d_tz,
            departure_datetime=dep_str,
            arrival_datetime=arr_str,
        )],
        prep_days=2,
        wake_time="07:00",
        sleep_time="23:00",
        uses_melatonin=True,
        uses_caffeine=True,
        uses_exercise=False,
        nap_preference="all_days",
        light_exposure_minutes=60,
    )
    defaults.update(kwargs)
    return ScheduleRequest(**defaults)


def _get_all_interventions(request: ScheduleRequest):
    """Run scheduler and flatten all interventions."""
    scheduler = SchedulerV2(request)
    response = scheduler.generate()
    return [item for day in response.interventions for item in day.items]


def _get_interventions_by_type(request, type_name):
    """Get all interventions of a specific type."""
    return [i for i in _get_all_interventions(request) if i.type == type_name]


class TestSummaryFieldPresent:
    """Every intervention must have a non-empty summary."""

    def test_all_interventions_have_summary(self):
        request = _make_request(direction="advance")
        interventions = _get_all_interventions(request)
        assert len(interventions) > 0
        for item in interventions:
            assert item.summary is not None, f"{item.type} on day missing summary"
            assert len(item.summary) > 0, f"{item.type} has empty summary"

    def test_all_interventions_have_summary_delay(self):
        request = _make_request(direction="delay")
        interventions = _get_all_interventions(request)
        assert len(interventions) > 0
        for item in interventions:
            assert item.summary is not None, f"{item.type} on day missing summary"
            assert len(item.summary) > 0, f"{item.type} has empty summary"


class TestSummaryContent:
    """Summary text should contain key personalized data."""

    def test_light_seek_includes_duration(self):
        request = _make_request(direction="advance", light_exposure_minutes=90)
        items = _get_interventions_by_type(request, "light_seek")
        assert len(items) > 0
        for item in items:
            assert "90" in item.summary, f"Expected '90' in summary: {item.summary}"

    def test_light_seek_default_duration(self):
        request = _make_request(direction="advance", light_exposure_minutes=60)
        items = _get_interventions_by_type(request, "light_seek")
        assert len(items) > 0
        for item in items:
            assert "60" in item.summary, f"Expected '60' in summary: {item.summary}"

    def test_light_avoid_includes_until(self):
        request = _make_request(direction="advance")
        items = _get_interventions_by_type(request, "light_avoid")
        if items:  # Not all schedules have light_avoid
            for item in items:
                assert "until" in item.summary.lower(), (
                    f"Expected 'until' in light_avoid summary: {item.summary}"
                )

    def test_melatonin_includes_dosage(self):
        request = _make_request(direction="advance", uses_melatonin=True)
        items = _get_interventions_by_type(request, "melatonin")
        if items:
            for item in items:
                assert "0.5mg" in item.summary, (
                    f"Expected '0.5mg' in melatonin summary: {item.summary}"
                )

    def test_nap_window_includes_duration(self):
        request = _make_request(direction="advance", nap_preference="all_days")
        items = _get_interventions_by_type(request, "nap_window")
        if items:
            for item in items:
                # Should contain duration info (hours or min)
                has_duration = ("h" in item.summary or "min" in item.summary)
                assert has_duration, (
                    f"Expected duration in nap_window summary: {item.summary}"
                )

    def test_sleep_target_includes_direction_advance(self):
        request = _make_request(direction="advance")
        items = _get_interventions_by_type(request, "sleep_target")
        if items:
            for item in items:
                assert "earlier" in item.summary.lower(), (
                    f"Expected 'earlier' in advance sleep summary: {item.summary}"
                )

    def test_sleep_target_includes_direction_delay(self):
        request = _make_request(direction="delay")
        items = _get_interventions_by_type(request, "sleep_target")
        if items:
            for item in items:
                assert "later" in item.summary.lower(), (
                    f"Expected 'later' in delay sleep summary: {item.summary}"
                )

    def test_wake_target_advance_mentions_light(self):
        request = _make_request(direction="advance")
        items = _get_interventions_by_type(request, "wake_target")
        assert len(items) > 0
        for item in items:
            assert "light" in item.summary.lower(), (
                f"Expected 'light' in advance wake summary: {item.summary}"
            )

    def test_caffeine_ok_summary(self):
        request = _make_request(direction="advance", uses_caffeine=True)
        items = _get_interventions_by_type(request, "caffeine_ok")
        if items:
            for item in items:
                assert "caffeine" in item.summary.lower()

    def test_caffeine_cutoff_summary(self):
        request = _make_request(direction="advance", uses_caffeine=True)
        items = _get_interventions_by_type(request, "caffeine_cutoff")
        if items:
            for item in items:
                assert "caffeine" in item.summary.lower()


class TestSummaryLength:
    """Summaries should be concise one-liners."""

    def test_summaries_under_60_chars(self):
        request = _make_request(direction="advance")
        interventions = _get_all_interventions(request)
        for item in interventions:
            assert len(item.summary) <= 60, (
                f"{item.type} summary too long ({len(item.summary)} chars): "
                f"{item.summary}"
            )
```

**Step 2: Run tests to verify they fail**

Run: `cd /Users/davidrecordon/Documents/dawnward && python -m pytest api/_python/tests/test_summary_field.py -v`
Expected: FAIL — `summary` is None for all interventions

**Step 3: Commit test file**

```
test: add tests for intervention summary field generation
```

---

### Task 3: Generate summaries in InterventionPlanner

**Files:**
- Modify: `api/_python/circadian/scheduling/intervention_planner.py`

**Context:** Every `Intervention(...)` constructor call in this file needs a `summary=` parameter. The planner has access to `self.context.direction`, `self.request.light_exposure_minutes`, `duration_min`, and computed end times.

**Step 1: Import the helper**

Add to imports at top of file:

```python
from circadian.types import format_duration_short
```

**Step 2: Add `summary=` to every Intervention constructor**

Here are the summary strings for each intervention creation site. The planner creates interventions in these methods:

**`_plan_overnight_flight_nap` (line ~508):**
```python
summary=f"Sleep opportunity (~{format_duration_short(int(sleep_hours * 60))})",
```

**`_plan_regular_flight_nap` (line ~545):**
```python
summary=f"Sleep opportunity (~{format_duration_short(int(flight_hours * 0.5 * 60))})",
```

**`_plan_single_recommendation` — wake_target (line ~595):**
```python
summary=("Target wake \u2014 get light after" if self.context.direction == "advance" else "Target wake \u2014 avoid light first"),
```

**`_plan_single_recommendation` — light_seek advance (line ~619):**
```python
summary=f"Bright light for {self.request.light_exposure_minutes} min",
```

**`_plan_single_recommendation` — melatonin delay (line ~641):**
```python
summary="Take 0.5mg melatonin",
```

**`_plan_single_recommendation` — light_seek delay (line ~657):**
```python
summary=f"Bright light for {self.request.light_exposure_minutes} min",
```

**`_plan_sleep_wake` — wake_target (line ~709):**
```python
summary=("Target wake \u2014 get light after" if self.context.direction == "advance" else "Target wake \u2014 avoid light first"),
```

**`_plan_sleep_wake` — sleep_target (line ~732):**
```python
summary=f"Target sleep \u2014 shifting {'earlier' if self.context.direction == 'advance' else 'later'}",
```

**`_plan_light` — light_seek advance (line ~770):**
```python
summary=f"Bright light for {self.request.light_exposure_minutes} min",
```

**`_plan_light` — light_avoid advance (line ~789):**
```python
summary=f"Avoid bright light until {format_time_12h(adj_end)}",
```

**`_plan_light` — light_seek delay (line ~809):**
```python
summary=f"Bright light for {self.request.light_exposure_minutes} min",
```

**`_plan_light` — light_avoid delay (line ~828):**
```python
summary=f"Avoid bright light until {format_time_12h(adj_end)}",
```

**`_plan_melatonin` — advance (line ~855):**
```python
summary="Take 0.5mg melatonin",
```

**`_plan_melatonin` — delay (line ~879):**
```python
summary="Take 0.5mg melatonin",
```

**`_plan_caffeine` — caffeine_ok (line ~902):**
```python
summary="Caffeine OK",
```

**`_plan_caffeine` — caffeine_cutoff (line ~922):**
```python
summary="Last caffeine \u2014 protect tonight's sleep",
```

**`_plan_nap` — recovery nap (line ~954):**
```python
summary=f"Recovery nap (up to {format_duration_short(nap_rec.max_duration_min)})",
```

**`_plan_nap` — optional nap (line ~972):**
```python
summary=f"Optional nap (up to {format_duration_short(nap_rec.max_duration_min)})",
```

**`_plan_exercise` (find this method):**
```python
summary="30 min activity to help shift rhythm",
```

**ULR flight nap windows (line ~453, inside loop):**
```python
summary=f"Sleep opportunity (~{format_duration_short(window_duration_min)})",
```
where `window_duration_min` is computed from the window data.

**Step 3: Run tests**

Run: `cd /Users/davidrecordon/Documents/dawnward && python -m pytest api/_python/tests/test_summary_field.py -v`
Expected: All PASS

**Step 4: Run full Python test suite**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run test:python`
Expected: All ~345+ tests pass

**Step 5: Run Python linting and type checking**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run lint:python && bun run typecheck:python`
Expected: Clean

**Step 6: Commit**

```
feat: generate personalized summary text for all intervention types
```

---

### Task 4: Add `summary` to TypeScript type and use it in frontend

**Files:**
- Modify: `src/types/schedule.ts` (~line 85, in Intervention interface)
- Modify: `src/components/schedule/day-summary-card.tsx` (lines 30-49)

**Step 1: Add to TypeScript Intervention interface**

In `src/types/schedule.ts`, add after `original_time?`:

```typescript
  /** One-line personalized summary for collapsed card view (generated by Python scheduler) */
  summary?: string;
```

**Step 2: Update `getCondensedDescription` in day-summary-card.tsx**

Replace the function (lines 42-49) with:

```typescript
function getCondensedDescription(intervention: Intervention): string {
  // Prefer scheduler-generated summary (personalized)
  if (intervention.summary) return intervention.summary;
  // Fallback for older schedules without summary field
  if (intervention.type === "nap_window") return intervention.title;
  return CONDENSED_DESCRIPTIONS[intervention.type] ?? "Follow this intervention";
}
```

**Step 3: Run TypeScript tests**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run test:run`
Expected: All ~525 tests pass (summary is optional, existing mocks don't set it)

**Step 4: Run linting and type checking**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run lint && bun run typecheck`
Expected: Clean

**Step 5: Commit**

```
feat: use Python-generated summary in collapsed card view

Falls back to static CONDENSED_DESCRIPTIONS for older schedules
that haven't been regenerated.
```

---

## Part 2: Remove scheduleViewMode Preference

### Task 5: Create DB migration to drop scheduleViewMode column

**Files:**
- Modify: `prisma/schema.prisma` (line 29)
- Create: new migration in `prisma/migrations/`

**Step 1: Remove from schema**

In `prisma/schema.prisma`, delete line 29:

```
  scheduleViewMode     String           @default("summary")
```

**Step 2: Generate migration**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun prisma migrate dev --name remove_schedule_view_mode`
Expected: Migration created successfully

**Step 3: Verify migration file**

Check that `prisma/migrations/YYYYMMDD_remove_schedule_view_mode/migration.sql` contains:

```sql
ALTER TABLE "User" DROP COLUMN "scheduleViewMode";
```

**Step 4: Commit**

```
chore: remove scheduleViewMode column from User model
```

---

### Task 6: Remove scheduleViewMode from types and utilities

**Files:**
- Modify: `src/types/user-preferences.ts` (remove type, constants, validators, interface properties)

**Step 1: Remove the type, constants, and validators (lines 1-21)**

Delete:
- Line 2: `export type ScheduleViewMode = "summary" | "timeline";`
- Line 5: `export const DEFAULT_SCHEDULE_VIEW_MODE: ScheduleViewMode = "summary";`
- Lines 7-21: `isValidScheduleViewMode()` and `getValidScheduleViewMode()` functions

**Step 2: Remove from DisplayPreferences interface (line 30)**

Delete `scheduleViewMode: ScheduleViewMode;` from the interface.

**Step 3: Remove from DbDisplayPreferences (line 39)**

Delete `scheduleViewMode?: string | null;`.

**Step 4: Remove from extractDisplayPreferences (line 52)**

Delete `scheduleViewMode: getValidScheduleViewMode(userPrefs?.scheduleViewMode),`.

**Step 5: Remove from UserPreferences interface (line 70)**

Delete `scheduleViewMode: ScheduleViewMode;`.

**Step 6: Remove from mapFormToDbPreferences (line 117)**

Delete `scheduleViewMode: DEFAULT_SCHEDULE_VIEW_MODE,`.

**Step 7: Run type checking to find remaining references**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run typecheck`
Expected: Type errors in files that still reference ScheduleViewMode or scheduleViewMode (will fix in subsequent tasks)

**Step 8: Commit**

```
refactor: remove ScheduleViewMode type and utilities
```

---

### Task 7: Remove scheduleViewMode from DisplayPreferencesContext

**Files:**
- Modify: `src/components/display-preferences-context.tsx`

**Step 1: Remove import**

Remove `ScheduleViewMode` from the import on line 6.

**Step 2: Remove from ProviderProps (line 17)**

Delete `scheduleViewMode?: ScheduleViewMode;`.

**Step 3: Remove from provider function parameter (line 33)**

Delete `scheduleViewMode = "summary",`.

**Step 4: Remove from value object (line 51)**

Delete `scheduleViewMode,` from the useMemo value.

**Step 5: Update useMemo dependencies (line 53)**

Change from `[effectiveFormat, showDualTimezone, scheduleViewMode]` to `[effectiveFormat, showDualTimezone]`.

**Step 6: Remove from default in useDisplayPreferences (line 73)**

Delete `scheduleViewMode: "summary",` from the fallback object.

**Step 7: Commit**

```
refactor: remove scheduleViewMode from display preferences context
```

---

### Task 8: Simplify trip-schedule-view.tsx to use viewport-only logic

**Files:**
- Modify: `src/components/trip-schedule-view.tsx` (lines 121, 129, 357-383)

**Step 1: Remove scheduleViewMode from destructure (line 121)**

Change:
```typescript
const { showDualTimezone, scheduleViewMode } = useDisplayPreferences();
```
To:
```typescript
const { showDualTimezone } = useDisplayPreferences();
```

**Step 2: Simplify the reset effect (lines 357-360)**

Change:
```typescript
useEffect(() => {
    hasInitializedExpandedDays.current = false;
}, [scheduleViewMode, isDesktop]);
```
To:
```typescript
useEffect(() => {
    hasInitializedExpandedDays.current = false;
}, [isDesktop]);
```

**Step 3: Simplify the initialization effect (lines 362-383)**

Replace:
```typescript
if (scheduleViewMode === "timeline" && isDesktop) {
    // Timeline mode on desktop: start with all days expanded
    const allDays = new Set(schedule.interventions.map((d) => d.day));
    setExpandedDays(allDays);
} else {
    // Summary mode (or mobile): auto-expand today's day only
```
With:
```typescript
if (isDesktop) {
    // Desktop: start with all days expanded
    const allDays = new Set(schedule.interventions.map((d) => d.day));
    setExpandedDays(allDays);
} else {
    // Mobile: auto-expand today's day only
```

**Step 4: Update the useEffect dependency array (line 383)**

Change from `[schedule, scheduleViewMode, isDesktop, tripData.originTz]` to `[schedule, isDesktop, tripData.originTz]`.

**Step 5: Commit**

```
refactor: use viewport-only logic for day expansion (desktop=expanded, mobile=collapsed)
```

---

### Task 9: Remove scheduleViewMode from settings form and API

**Files:**
- Modify: `src/components/settings-form.tsx` (lines 35, 267-286)
- Modify: `src/app/api/user/preferences/route.ts` (lines 36, 65, 129)
- Modify: `src/app/settings/page.tsx` (lines 46, 86)

**Step 1: settings-form.tsx — Remove from interface (line 35)**

Delete `scheduleViewMode: string;` from the `UserPreferences` interface.

**Step 2: settings-form.tsx — Remove PreferenceSelector UI (lines 267-286)**

Delete the entire `<PreferenceSelector>` block for "Schedule view default" (the one with `icon={<List>}` and `value={preferences.scheduleViewMode}`).

**Step 3: settings-form.tsx — Remove `List` from lucide imports (line 9)**

Remove `List,` from the import if it's no longer used.

**Step 4: preferences route.ts — Remove from Zod schema (line 36)**

Delete `scheduleViewMode: z.enum(["summary", "timeline"]).optional(),`.

**Step 5: preferences route.ts — Remove from GET select (line 65)**

Delete `scheduleViewMode: true,`.

**Step 6: preferences route.ts — Remove from PATCH select (line 129)**

Delete `scheduleViewMode: true,`.

**Step 7: settings/page.tsx — Remove from select (line 46)**

Delete `scheduleViewMode: true,`.

**Step 8: settings/page.tsx — Remove from data mapping (line 86)**

Delete `scheduleViewMode: user.scheduleViewMode,`.

**Step 9: Commit**

```
refactor: remove scheduleViewMode from settings UI and preferences API
```

---

### Task 10: Remove scheduleViewMode from trip page providers

**Files:**
- Modify: `src/app/trip/[id]/page.tsx` (line 38)
- Modify: `src/app/s/[code]/page.tsx` (line 43)

**Step 1: trip/[id]/page.tsx — Remove from select (line 38)**

Delete `scheduleViewMode: true,`.

**Step 2: s/[code]/page.tsx — Remove from select (line 43)**

Delete `scheduleViewMode: true,`.

Note: The `<DisplayPreferencesProvider {...displayPrefs}>` spread will automatically stop passing `scheduleViewMode` since `extractDisplayPreferences` no longer returns it (Task 6).

**Step 3: Commit**

```
refactor: remove scheduleViewMode from trip page data fetching
```

---

### Task 11: Update tests

**Files:**
- Modify: `src/types/__tests__/user-preferences.test.ts`
- Modify: `src/components/__tests__/display-preferences-context.test.tsx`
- Modify: `src/app/api/user/preferences/__tests__/route.test.ts` (if it tests scheduleViewMode)

**Step 1: user-preferences.test.ts — Remove from test fixtures**

Remove `scheduleViewMode` from all test objects (lines ~20, 49, 91, 107). Remove any test cases that specifically test `isValidScheduleViewMode` or `getValidScheduleViewMode`.

**Step 2: display-preferences-context.test.tsx — Remove scheduleViewMode tests**

Remove test cases and assertions that check `scheduleViewMode` values (lines ~21, 45, 70-77, 87-95, 107).

**Step 3: preferences route test — Remove scheduleViewMode**

If `src/app/api/user/preferences/__tests__/route.test.ts` includes `scheduleViewMode` in test payloads or assertions, remove those.

**Step 4: Run all TypeScript tests**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run test:run`
Expected: All pass

**Step 5: Run type checking**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run typecheck`
Expected: No errors

**Step 6: Run linting**

Run: `cd /Users/davidrecordon/Documents/dawnward && bun run lint && bun run format:check`
Expected: Clean

**Step 7: Commit**

```
test: update tests after scheduleViewMode removal
```

---

### Task 12: Update documentation

**Files:**
- Modify: `CLAUDE.md` (lines ~232, ~250)
- Modify: `design_docs/decisions-overview.md` (line ~77)
- Modify: `design_docs/frontend-design.md` (line ~250)
- Modify: `design_docs/exploration/configuration-audit.md` (lines ~425, ~444)

**Step 1: CLAUDE.md — Update Schedule View Modes section (line ~232)**

Replace the "Schedule View Modes" section with:

```markdown
**Schedule View Modes**: Viewport-driven behavior:
- **Desktop**: All days start expanded showing full `DaySection` detail view
- **Mobile**: All days start collapsed showing `DaySummaryCard`. Today's day auto-expands. Users can expand/collapse individual days.
```

**Step 2: CLAUDE.md — Remove from User model description (line ~250)**

Remove `scheduleViewMode` from the User preferences list.

**Step 3: Update design docs**

Update `decisions-overview.md`, `frontend-design.md`, and `configuration-audit.md` to reflect that `scheduleViewMode` was removed in favor of viewport-driven behavior.

**Step 4: Commit**

```
docs: update documentation after scheduleViewMode removal
```

---

### Task 13: Final verification

**Step 1: Run full test suite**

```bash
cd /Users/davidrecordon/Documents/dawnward
bun run lint
bun run format:check
bun run typecheck
bun run test:run
bun run lint:python
bun run typecheck:python
bun run test:python
```

Expected: All pass, no errors

**Step 2: Start dev server and verify visually**

Run: `bun dev`

- Desktop: verify all days start expanded
- Mobile viewport (responsive): verify days start collapsed, today expanded
- Generate a new schedule: verify summary text is personalized (not static)
- Check an old schedule: verify fallback to static CONDENSED_DESCRIPTIONS

**Step 3: Commit any cleanup**

If any issues found, fix and commit.
