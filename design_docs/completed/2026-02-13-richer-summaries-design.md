# Richer Summary Cards + Remove scheduleViewMode

## Problem

Summary card descriptions are static and generic. Every trip shows the same text regardless of duration, direction, or user preferences. The `nap_window` type is the worst offender ("Good window for a short nap" whether it's 2h or 8h), but all types lose personalization in summary mode.

Separately, the `scheduleViewMode` preference is overcomplicated. Mobile always collapses to summary mode regardless of the preference, making "timeline" misleading for mobile users. The preference only matters for desktop+timeline users — a narrow audience for a settings toggle.

## Solution

Two complementary changes:

### 1. Python-Generated `summary` Field

Add a `summary` field to `Intervention` generated by the Python scheduler. This one-liner is personalized using data already available at generation time (duration, direction, dosage, end times).

**Data model:**

```python
# Python
@dataclass
class Intervention:
    summary: str | None = None  # One-line for collapsed card view
```

```typescript
// TypeScript
interface Intervention {
  summary?: string;
}
```

**Frontend fallback:**

```typescript
function getCondensedDescription(intervention: Intervention): string {
  if (intervention.summary) return intervention.summary;
  if (intervention.type === "nap_window") return intervention.title;
  return CONDENSED_DESCRIPTIONS[intervention.type] ?? "Follow this intervention";
}
```

**Summary text per type:**

| Type | Template | Example |
|------|----------|---------|
| `wake_target` | "Target wake — {light_hint}" | "Target wake — get light after" |
| `light_seek` | "Bright light for {duration}min" | "Bright light for 60 min" |
| `light_avoid` | "Avoid bright light until {end_time}" | "Avoid bright light until 2:30 PM" |
| `melatonin` | "Take 0.5mg melatonin" | "Take 0.5mg melatonin" |
| `caffeine_ok` | "Caffeine OK" | "Caffeine OK" |
| `caffeine_cutoff` | "Last caffeine — protect tonight's sleep" | same |
| `sleep_target` | "Target sleep — shifting {direction}" | "Target sleep — shifting earlier" |
| `nap_window` (in-flight) | "Sleep opportunity (~{hours}h)" | "Sleep opportunity (~4h)" |
| `nap_window` (recovery) | "Recovery nap (up to {duration})" | "Recovery nap (up to 1.5h)" |
| `nap_window` (optional) | "Optional nap (up to {duration})" | "Optional nap (up to 30 min)" |
| `exercise` | "30 min activity to help shift rhythm" | same |

**Duration formatting rule:** >= 60 min uses hours (1.5h, 4h), < 60 min uses minutes (30 min).

### 2. Remove `scheduleViewMode` Preference

Replace the preference with viewport-driven behavior:
- **Desktop:** All days start expanded (timeline detail view)
- **Mobile:** All days start collapsed (summary cards), today auto-expands

**What gets removed:**
- `scheduleViewMode` column from User model (DB migration)
- Settings UI toggle for schedule view
- `DisplayPreferencesContext` provider and `useScheduleViewMode` hook
- Type definitions for `ScheduleViewMode`
- All conditional logic branching on `scheduleViewMode`
- References in CLAUDE.md documentation

**What stays:**
- `DaySummaryCard` component (still used for collapsed state)
- Per-day expand/collapse toggle (user can still manually expand/collapse)
- Mobile detection via `useMediaQuery` (already exists)

## Files Changed

### Part 1: Summary field
| File | Change |
|------|--------|
| `api/_python/circadian/types.py` | Add `summary` field |
| `api/_python/circadian/scheduling/intervention_planner.py` | Generate `summary=` for all interventions |
| `src/types/schedule.ts` | Add `summary?: string` |
| `src/components/schedule/day-summary-card.tsx` | Use `intervention.summary` with fallback |
| Python tests | Verify summary populated for each type |
| TypeScript tests | Update mocks, test fallback |

### Part 2: Remove scheduleViewMode
~19 files touched (DB, types, API, settings UI, context, pages, tests, docs).

## Migration

- No DB migration for Part 1 (JSON field in schedule data)
- DB migration for Part 2 (remove `scheduleViewMode` column)
- Run `scripts/regenerate-schedules.ts --all-trips` after deploying Part 1 to backfill summaries
- Old schedules gracefully fall back to static `CONDENSED_DESCRIPTIONS`

## Testing

- Python: verify `summary` field on all intervention types, various directions/durations
- TypeScript: verify `getCondensedDescription` prefers `summary`, falls back correctly
- E2E: verify mobile shows collapsed cards with new summary text
- Manual: verify desktop shows expanded timeline, mobile shows rich summaries
