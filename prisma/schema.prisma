generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String           @id @default(cuid())
  email                String           @unique
  emailVerified        DateTime?
  name                 String?
  image                String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  defaultPrepDays      Int              @default(3)
  defaultWakeTime      String           @default("07:00")
  defaultSleepTime     String           @default("23:00")
  usesMelatonin        Boolean          @default(true)
  usesCaffeine         Boolean          @default(true)
  caffeineCutoffHours  Int              @default(8)
  scheduleIntensity    String           @default("balanced")
  napPreference        String           @default("flight_only")
  usesExercise         Boolean          @default(false)
  lightExposureMinutes Int              @default(60)
  showDualTimezone     Boolean          @default(false)
  use24HourFormat      Boolean          @default(false)
  emailNotifications   Boolean          @default(false)
  accounts             Account[]
  calendarSyncs        CalendarSync[]
  sessions             Session[]
  sharedSchedules      SharedSchedule[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SharedSchedule {
  id                    String                @id @default(cuid())
  code                  String?               @unique @db.VarChar(8)
  userId                String?
  originTz              String
  destTz                String
  departureDatetime     String
  arrivalDatetime       String
  prepDays              Int
  wakeTime              String
  sleepTime             String
  usesMelatonin         Boolean
  usesCaffeine          Boolean
  usesExercise          Boolean
  napPreference         String                @default("flight_only")
  scheduleIntensity     String                @default("balanced")
  routeLabel            String?
  viewCount             Int                   @default(0)
  createdAt             DateTime              @default(now())
  lastViewedAt          DateTime?
  currentScheduleJson   Json?
  initialScheduleJson   Json?
  lastRecalculatedAt    DateTime?
  leg2ArrivalDatetime   String?
  leg2DepartureDatetime String?
  leg2DestTz            String?
  leg2OriginTz          String?
  flightDayEmailSentAt  DateTime?
  calendarSyncs         CalendarSync[]
  actuals               InterventionActual[]
  stateSnapshots        MarkerStateSnapshot[]
  user                  User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model InterventionActual {
  id               String         @id @default(cuid())
  scheduleId       String
  legIndex         Int            @default(0)
  dayOffset        Int
  interventionType String
  plannedTime      String
  actualTime       String?
  status           String
  source           String         @default("manual")
  recordedAt       DateTime       @default(now())
  schedule         SharedSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, legIndex, dayOffset, interventionType])
  @@index([scheduleId])
}

model MarkerStateSnapshot {
  id              String         @id @default(cuid())
  scheduleId      String
  legIndex        Int            @default(0)
  dayOffset       Int
  cumulativeShift Float
  cbtminMinutes   Int
  dlmoMinutes     Int
  direction       String
  capturedAt      DateTime       @default(now())
  schedule        SharedSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, legIndex, dayOffset])
  @@index([scheduleId])
}

model CalendarSync {
  id             String         @id @default(cuid())
  tripId         String
  userId         String
  googleEventIds String[]
  lastSyncedAt   DateTime       @default(now())

  // Background sync status tracking
  status         String         @default("completed") // "syncing" | "completed" | "failed"
  errorMessage   String?
  errorCode      String?        // "token_revoked" | "rate_limit" | "network" | etc.
  startedAt      DateTime?
  eventsCreated  Int?           // Track actual count
  eventsFailed   Int?           // Track failures for warnings

  trip           SharedSchedule @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

